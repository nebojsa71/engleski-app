<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="description" content="Aplikacija za uƒçenje engleskog jezika namenjena putnicima - PutujGovori">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="PutujGovori">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#6366f1">
  <meta name="msapplication-tap-highlight" content="no">
  
  <title>PutujGovori - English Learning App</title>
  
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #1f2937;
      line-height: 1.6;
    }

    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #1f2937;
      padding: 1rem 1.5rem;
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-title {
      margin-bottom: 0.5rem;
    }

    .level-selector {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .level-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #6366f1;
      background: white;
      color: #6366f1;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .level-btn.active {
      background: #6366f1;
      color: white;
    }

    .level-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .header-progress {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: #6366f1;
      background: rgba(99, 102, 241, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      border: 1px solid rgba(99, 102, 241, 0.2);
      margin: 0 auto;
      max-width: 200px;
    }

    .header-progress-bar {
      width: 60px;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }

    .header-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      width: 0%;
      transition: width 0.8s ease-in-out;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }

    .progress {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      text-align: center;
      margin-bottom: 2rem;
      padding: 1.5rem;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .progress h3 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #374151;
    }

    .progress-text {
      font-size: 2rem;
      font-weight: 700;
      color: #6366f1;
      margin-bottom: 1rem;
    }

    .bar {
      height: 12px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .bar-inner {
      height: 100%;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      width: 0%;
      border-radius: 10px;
      transition: width 0.8s ease-in-out;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .lessons-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.5rem;
    }

    .lesson {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1.5rem;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .lesson::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .lesson:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .lesson:hover::before {
      transform: scaleX(1);
    }

    .lesson h3 {
      font-size: 1.3rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .lesson h3::before {
      content: 'üìö';
      font-size: 1.2rem;
    }

    .phrases {
      display: none;
      margin-top: 1.5rem;
      animation: slideDown 0.3s ease-out;
      padding: 0.5rem;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .phrase {
      background: #f8fafc;
      padding: 2rem;
      margin: 1rem 0;
      border-radius: 16px;
      border-left: 4px solid #6366f1;
      transition: all 0.3s ease;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .phrase:hover {
      background: #f1f5f9;
      transform: translateX(4px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .phrase strong {
      color: #1e40af;
      font-size: 1.3rem;
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 700;
      line-height: 1.4;
    }

    .phrase div {
      color: #374151;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }

    .phrase em {
      color: #6b7280;
      font-style: normal;
      font-size: 1rem;
      display: block;
      margin-top: 0.8rem;
      font-weight: 500;
      background: rgba(99, 102, 241, 0.1);
      padding: 0.5rem;
      border-radius: 8px;
      margin-left: auto;
      margin-right: auto;
      max-width: fit-content;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .listen-btn, .btn {
      transition: all 0.3s ease;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      height: 40px;
    }
    
    .listen-btn {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }
    
    .speech-modal {
      animation: modalSlideIn 0.3s ease-out;
      border-radius: 20px !important;
      border: 2px solid rgba(99, 102, 241, 0.2) !important;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
      background: white !important;
      max-width: 600px !important;
      width: 90vw !important;
    }
    
    .speech-modal h3 {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      margin: -2rem -2rem 1rem -2rem;
      padding: 1.5rem 2rem;
      border-radius: 18px 18px 0 0;
      font-size: 1.3rem;
      font-weight: 600;
      text-align: center;
    }
    
    .speech-modal #recognition-result {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9) !important;
      border: 2px solid #e2e8f0 !important;
      border-radius: 12px !important;
      padding: 1.5rem !important;
      margin: 1rem 0 !important;
      min-height: 80px !important;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    .speech-modal button {
      background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
      color: white !important;
      border: none !important;
      padding: 0.8rem 1.5rem !important;
      border-radius: 12px !important;
      cursor: pointer !important;
      font-weight: 600 !important;
      font-size: 0.95rem !important;
      transition: all 0.3s ease !important;
      margin: 0.5rem !important;
      min-width: 120px !important;
    }
    
    .speech-modal button:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3) !important;
    }
    
    .speech-modal button[onclick*="remove"] {
      background: linear-gradient(135deg, #ef4444, #dc2626) !important;
    }
    
    .speech-modal button[onclick*="remove"]:hover {
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3) !important;
    }

    .quiz-btn {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      margin-top: 1rem;
      width: 100%;
      justify-content: center;
    }

    .quiz-btn:hover {
      background: linear-gradient(135deg, #059669, #047857);
    }

    .quiz-container {
      background: #f8fafc;
      padding: 1.5rem;
      border-radius: 15px;
      margin-top: 1rem;
      border: 2px solid #e2e8f0;
      position: relative;
    }

    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e2e8f0;
    }

    .quiz-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1f2937;
    }

    .quiz-progress {
      background: #e5e7eb;
      border-radius: 10px;
      padding: 0.3rem 0.8rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: #374151;
    }

    .quiz-question {
      font-size: 1.4rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1.5rem;
      text-align: center;
      padding: 1rem;
      background: white;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .quiz-options {
      display: grid;
      gap: 1rem;
    }

    .quiz-option {
      background: white;
      border: 2px solid #e2e8f0;
      padding: 1.2rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      font-size: 1rem;
      text-align: left;
      position: relative;
    }

    .quiz-option:hover {
      border-color: #6366f1;
      background: #f8fafc;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .quiz-option:active {
      transform: translateY(0);
    }

    .quiz-option.correct {
      border-color: #10b981;
      background: #f0fdf4;
      color: #065f46;
    }

    .quiz-option.incorrect {
      border-color: #ef4444;
      background: #fef2f2;
      color: #991b1b;
    }

    .quiz-option.selected {
      border-color: #6366f1;
      background: #eff6ff;
      color: #1e40af;
    }

    .quiz-result {
      text-align: center;
      padding: 2rem;
      border-radius: 15px;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .quiz-result.excellent {
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      border: 2px solid #10b981;
      color: #065f46;
    }

    .quiz-result.good {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 2px solid #f59e0b;
      color: #92400e;
    }

    .quiz-result.poor {
      background: linear-gradient(135deg, #fef2f2, #fecaca);
      border: 2px solid #ef4444;
      color: #991b1b;
    }

    .quiz-feedback {
      margin-top: 1rem;
      font-size: 1rem;
      font-weight: 500;
      opacity: 0.9;
    }

    .quiz-close-btn {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      margin-top: 1rem;
      transition: all 0.3s ease;
    }

    .quiz-close-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease-out;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 2rem;
      border-bottom: 2px solid #e5e7eb;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 20px 20px 0 0;
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1f2937;
    }

    .modal-close {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: #dc2626;
      transform: scale(1.1);
    }

    .modal-body {
      padding: 2rem;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(-50px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* Responsive design for lesson cards */
    @media (max-width: 768px) {
      .modal-content {
        margin: 1rem;
        max-width: calc(100vw - 2rem);
        max-height: calc(100vh - 2rem);
      }
      
      .speech-modal {
        max-width: calc(100vw - 2rem) !important;
        width: calc(100vw - 2rem) !important;
        margin: 1rem !important;
      }
      
      .modal-body {
        padding: 1.5rem;
      }
      
      .modal-header {
        padding: 1rem 1.5rem;
      }
      
      .container {
        padding: 0 1rem;
        margin: 1rem auto;
      }
      
      .lessons-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 1rem !important;
        padding: 0.5rem !important;
      }
      
      header {
        font-size: 1.5rem;
        padding: 1rem;
      }
      
      .lesson-card {
        padding: 1rem !important;
        margin-bottom: 0.5rem !important;
      }
      .lesson-card h3 {
        font-size: 1rem !important;
      }
      .lesson-card div {
        font-size: 0.8rem !important;
      }
    }

    @media (max-width: 480px) {
      .lessons-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.75rem !important;
        padding: 0.5rem !important;
      }
      .lesson-card {
        padding: 0.75rem !important;
      }
      .lesson-card h3 {
        font-size: 0.9rem !important;
      }
      .lesson-card div {
        font-size: 0.75rem !important;
      }
      
      .speech-modal {
        max-width: calc(100vw - 1rem) !important;
        width: calc(100vw - 1rem) !important;
        margin: 0.5rem !important;
      }
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: #6b7280;
      font-size: 1.1rem;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #6366f1;
      animation: spin 1s ease-in-out infinite;
      margin-left: 0.5rem;
    }

    .error {
      text-align: center;
      padding: 2rem;
      color: #dc2626;
      background: #fef2f2;
      border-radius: 15px;
      margin: 1rem 0;
      border: 1px solid #fecaca;
    }

    .completed {
      position: relative;
    }

    .completed::after {
      content: '‚úÖ';
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
    }

    body.dark {
      background: linear-gradient(135deg, #232946 0%, #121629 100%);
      color: #f4f4f4;
    }
    body.dark header, body.dark .container, body.dark .progress, body.dark .lesson, body.dark .quiz-container, body.dark .modal-content {
      background: rgba(30, 32, 48, 0.97) !important;
      color: #f4f4f4 !important;
      border-color: #232946 !important;
    }
    body.dark .lesson, body.dark .quiz-container, body.dark .modal-content {
      box-shadow: 0 8px 32px rgba(0,0,0,0.5) !important;
    }
    body.dark .bar-inner {
      background: linear-gradient(90deg, #818cf8, #a5b4fc);
    }
    body.dark .phrase {
      background: #232946 !important;
      color: #f4f4f4 !important;
      border-left: 4px solid #818cf8;
    }
    body.dark .phrase em {
      background: rgba(129, 140, 248, 0.15);
      color: #a5b4fc;
    }
    body.dark .listen-btn, body.dark .quiz-btn, body.dark .quiz-close-btn {
      background: linear-gradient(135deg, #818cf8, #6366f1) !important;
      color: #fff !important;
    }
    body.dark .modal-header {
      background: linear-gradient(135deg, #232946, #6366f1) !important;
      color: #fff !important;
    }
    body.dark .quiz-option {
      background: #232946 !important;
      color: #f4f4f4 !important;
      border-color: #6366f1 !important;
    }
    body.dark .quiz-option.correct {
      background: #14532d !important;
      color: #bbf7d0 !important;
    }
    body.dark .quiz-option.incorrect {
      background: #7f1d1d !important;
      color: #fecaca !important;
    }
    body.dark .quiz-result {
      background: linear-gradient(135deg, #232946, #818cf8) !important;
      color: #fff !important;
    }
    body.dark .error {
      background: #7f1d1d !important;
      color: #fecaca !important;
      border-color: #fecaca !important;
    }

    body.dark .speech-modal {
      background: #1e1b4b !important;
      color: #f4f4f4 !important;
      border: 1px solid #232946 !important;
    }

    body.dark .speech-modal #recognition-result {
      background: #232946 !important;
      color: #f4f4f4 !important;
    }

    body.dark .menu-modal {
      background: rgba(30, 32, 48, 0.97) !important;
      color: #f4f4f4 !important;
    }

    body.dark .menu-modal #menu-stats {
      background: #232946 !important;
      color: #f4f4f4 !important;
    }

    body.dark .header-progress {
      background: rgba(129, 140, 248, 0.15) !important;
      color: #a5b4fc !important;
      border-color: rgba(129, 140, 248, 0.3) !important;
    }

    body.dark .header-progress-bar {
      background: #374151 !important;
    }

    body.dark .header-progress-fill {
      background: linear-gradient(90deg, #818cf8, #a5b4fc) !important;
    }

    body.dark .lesson-card {
      background: #232946 !important;
      border-color: #374151 !important;
      color: #f4f4f4 !important;
    }

    body.dark .lesson-card:hover {
      border-color: #6366f1 !important;
      background: #1e1b4b !important;
    }

    body.dark .lesson-card h3 {
      color: #f4f4f4 !important;
    }

    body.dark .lesson-card div {
      color: #a5b4fc !important;
    }

    body.dark .phrase {
      background: #232946 !important;
      border-color: #374151 !important;
      color: #f4f4f4 !important;
    }

    body.dark .phrase strong {
      color: #f4f4f4 !important;
    }

    body.dark .phrase div {
      color: #d1d5db !important;
    }

    body.dark .phrase em {
      color: #a5b4fc !important;
    }

    body.dark .modal-content {
      background: #1e1b4b !important;
      color: #f4f4f4 !important;
    }

    body.dark .modal-header {
      background: linear-gradient(135deg, #312e81, #1e1b4b) !important;
      border-bottom-color: #374151 !important;
    }

    body.dark .modal-title {
      color: #f4f4f4 !important;
    }

    body.dark .modal-body {
      background: #1e1b4b !important;
    }

    body.dark .phrase {
      background: #232946 !important;
      border-color: #374151 !important;
      color: #f4f4f4 !important;
    }

    body.dark .phrase strong {
      color: #f4f4f4 !important;
    }

    body.dark .phrase div {
      color: #d1d5db !important;
    }

    body.dark .phrase em {
      color: #a5b4fc !important;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Splash Screen */
    .splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
    }

    .splash-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .splash-logo {
      font-size: 4rem;
      margin-bottom: 1rem;
      animation: logoBounce 2s ease-in-out infinite;
    }

    .splash-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: white;
      margin-bottom: 0.5rem;
      text-align: center;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .splash-subtitle {
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 2rem;
      text-align: center;
    }

    .splash-loader {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .splash-progress {
      width: 200px;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      margin-top: 1rem;
      overflow: hidden;
    }

    .splash-progress-bar {
      height: 100%;
      background: white;
      border-radius: 2px;
      width: 0%;
      transition: width 0.3s ease;
      animation: progressFill 2s ease-in-out;
    }

    @keyframes logoBounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }

    @keyframes progressFill {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    /* Hide main content initially */
    .main-content {
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }

    .main-content.show {
      opacity: 1;
    }

    body.dark .phrase em {
      color: #a5b4fc !important;
    }

    body.dark .splash-screen {
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%) !important;
    }

    body.dark .splash-title {
      color: #f4f4f4 !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
    }

    body.dark .splash-subtitle {
      color: rgba(244, 244, 244, 0.8) !important;
    }
    
    body.dark #install-button {
      background: linear-gradient(135deg, #818cf8, #6366f1) !important;
      box-shadow: 0 8px 25px rgba(129, 140, 248, 0.3) !important;
    }
    
    body.dark #install-button:hover {
      box-shadow: 0 12px 35px rgba(129, 140, 248, 0.4) !important;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      margin: 15% auto;
      padding: 2rem;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal h3 {
      color: #1f2937;
      margin-bottom: 1rem;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .modal p {
      color: #6b7280;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .modal-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .modal-btn.primary {
      background: #6366f1;
      color: white;
    }

    .modal-btn.primary:hover {
      background: #5855eb;
      transform: translateY(-2px);
    }

    .modal-btn.secondary {
      background: #f3f4f6;
      color: #6b7280;
    }

    .modal-btn.secondary:hover {
      background: #e5e7eb;
    }

    /* Update notification */
    .update-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
      z-index: 1001;
      display: none;
      animation: slideInRight 0.3s ease-out;
      max-width: 300px;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .update-notification h4 {
      margin-bottom: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
    }

    .update-notification p {
      margin-bottom: 1rem;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .update-notification .update-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .update-notification .update-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .update-notification .close-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.3s ease;
    }

    .update-notification .close-btn:hover {
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div class="splash-screen" id="splash-screen">
    <div class="splash-logo">üåç</div>
    <div class="splash-title">PutujGovori</div>
    <div class="splash-subtitle">Uƒçite engleski za putovanja</div>
    <div class="splash-loader"></div>
    <div class="splash-progress">
      <div class="splash-progress-bar"></div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="main-content">
    <header>
      <div class="header-title">üåç PutujGovori</div>
      <div class="level-selector">
        <button class="level-btn" onclick="selectLevel('beginner')">Osnovni</button>
        <button class="level-btn" onclick="selectLevel('intermediate')">Srednji</button>
        <button class="level-btn" onclick="selectLevel('advanced')">Napredni</button>
      </div>
      <div class="header-progress">
        <span id="header-progress-text">0%</span>
        <div class="header-progress-bar">
          <div class="header-progress-fill" id="header-progress-fill"></div>
        </div>
      </div>
      <button id="menu-btn" title="Meni" style="position:absolute;top:1rem;right:1.5rem;font-size:1.2rem;cursor:pointer;background:none;border:none;">‚ò∞</button>
    </header>
    <div class="container">
      <div id="phrase-of-day" style="margin-bottom:2rem;text-align:center;"></div>
      <div id="lessons">
        <div class="loading">Uƒçitavanje lekcija...</div>
      </div>
    </div>
  </div>

  <!-- Update notification -->
  <div id="updateNotification" class="update-notification">
    <button class="close-btn" onclick="hideUpdateNotification()">√ó</button>
    <h4>üîÑ Nova verzija dostupna</h4>
    <p>Dostupna je nova verzija aplikacije sa pobolj≈°anjima i novim funkcionalnostima.</p>
    <button class="update-btn" onclick="updateApp()">A≈æuriraj sada</button>
  </div>

  <!-- Reset Progress Modal -->
  <div id="resetModal" class="modal">
    <div class="modal-content">
      <h3>üîÑ Resetuj napredak</h3>
      <p>Da li ste sigurni da ≈æelite da obri≈°ete sav napredak i poƒçnete iznova? Ova akcija se ne mo≈æe poni≈°titi.</p>
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="closeResetModal()">Otka≈æi</button>
        <button class="modal-btn primary" onclick="confirmReset()">Obri≈°i sve</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal">
    <div class="modal-content">
      <h3>‚úÖ Uspe≈°no!</h3>
      <p id="successMessage">Operacija je uspe≈°no zavr≈°ena.</p>
      <div class="modal-buttons">
        <button class="modal-btn primary" onclick="closeSuccessModal()">U redu</button>
      </div>
    </div>
  </div>

  <script>
  // PWA Installation functionality - moved to the beginning
  let deferredPrompt;
  
  // Enhanced debugging for mobile
  console.log('=== PWA DEBUG INFO ===');
  console.log('URL:', window.location.href);
  console.log('User Agent:', navigator.userAgent);
  console.log('Is Mobile:', /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
  console.log('Is HTTPS:', location.protocol === 'https:');
  console.log('Is localhost:', location.hostname === 'localhost' || location.hostname === '127.0.0.1');
  console.log('Is GitHub Pages:', location.hostname.includes('github.io'));
  console.log('Is standalone:', window.matchMedia('(display-mode: standalone)').matches);
  console.log('Navigator standalone:', window.navigator.standalone);
  console.log('Service Worker support:', 'serviceWorker' in navigator);
  console.log('BeforeInstallPrompt support:', 'onbeforeinstallprompt' in window);
  
  // Check installation status
  function checkInstallationStatus() {
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    const isHttps = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const hasServiceWorker = 'serviceWorker' in navigator;
    
    console.log('PWA Installation Status:');
    console.log('- Is standalone:', isStandalone);
    console.log('- Is HTTPS/localhost:', isHttps);
    console.log('- Has service worker support:', hasServiceWorker);
    console.log('- Protocol:', location.protocol);
    console.log('- Hostname:', location.hostname);
    
    return {
      isInstalled: isStandalone,
      canInstall: isHttps && hasServiceWorker && !isStandalone,
      reason: isStandalone ? 'already_installed' : 
              !isHttps ? 'not_https' : 
              !hasServiceWorker ? 'no_service_worker' : 'available'
    };
  }
  
  // Debug information
  console.log('PWA Installation Debug:');
  console.log('- Protocol:', location.protocol);
  console.log('- Hostname:', location.hostname);
  console.log('- Is HTTPS:', location.protocol === 'https:');
  console.log('- Is localhost:', location.hostname === 'localhost' || location.hostname === '127.0.0.1');
  console.log('- Is standalone:', window.matchMedia('(display-mode: standalone)').matches);
  console.log('- Navigator standalone:', window.navigator.standalone);
  
  // Check status on load
  const installStatus = checkInstallationStatus();
  if (installStatus.isInstalled) {
    console.log('‚úÖ App is already installed and running in standalone mode');
  }
  
  // Listen for the beforeinstallprompt event
  window.addEventListener('beforeinstallprompt', (e) => {
    console.log('‚úÖ beforeinstallprompt event fired - installation is available');
    
    // Prevent the mini-infobar from appearing on mobile
    e.preventDefault();
    
    // Stash the event so it can be triggered later
    deferredPrompt = e;
    
    // Don't show install button automatically - only in menu
    console.log('Install prompt available - will show in menu only');
    
    // Update installation status if menu is open
    updateInstallStatus();
  });
  
  // Listen for when beforeinstallprompt doesn't fire (installation not available)
  window.addEventListener('load', () => {
    // Wait a bit to see if beforeinstallprompt fires
    setTimeout(() => {
      if (!deferredPrompt) {
        const status = checkInstallationStatus();
        if (!status.isInstalled) {
          console.log('‚ÑπÔ∏è beforeinstallprompt did not fire - installation may not be available');
          console.log('Installation status:', status);
        }
      }
      
      // Update installation status periodically
      setInterval(() => {
        updateInstallStatus();
      }, 2000); // Check every 2 seconds
    }, 1000);
  });
  
  // Listen for successful installation
  window.addEventListener('appinstalled', () => {
    console.log('PWA was installed');
    // Clear the deferredPrompt variable
    deferredPrompt = null;
    
    // Update installation status if menu is open
    updateInstallStatus();
    
    // Show success message using modal
    showSuccessModal('üéâ Aplikacija je uspe≈°no instalirana! Mo≈æete je pokrenuti sa desktop-a ili iz menija aplikacija.');
  });

  // Register service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js?v=2')
        .then(registration => {
          console.log('‚úÖ ServiceWorker registered successfully:', registration);
          console.log('Service Worker state:', registration.active ? 'active' : 'not active');
        })
        .catch(error => {
          console.log('‚ùå ServiceWorker registration failed:', error);
        });
    });
  }

  // Check manifest
  fetch('./manifest.json')
    .then(response => response.json())
    .then(manifest => {
      console.log('‚úÖ Manifest loaded successfully:', manifest);
      console.log('Manifest start_url:', manifest.start_url);
      console.log('Manifest scope:', manifest.scope);
    })
    .catch(error => {
      console.log('‚ùå Manifest loading failed:', error);
    });

  function updateProgress(total) {
    // Broji ukupan broj zavr≈°enih lekcija iz svih nivoa
    let totalCompleted = 0;
    let totalLessons = 0;
    
    const levels = ['beginner', 'intermediate', 'advanced'];
    levels.forEach(level => {
      if (lessonsData[level]) {
        const levelLessons = lessonsData[level].length;
        totalLessons += levelLessons;
        
        for (let i = 0; i < levelLessons; i++) {
          if (localStorage.getItem(`lesson_${level}_${i}`) === 'done') {
            totalCompleted++;
          }
        }
      } else {
        // Ako nivo nije uƒçitan, dodaj default broj lekcija
        totalLessons += 15;
        
        for (let i = 0; i < 15; i++) {
          if (localStorage.getItem(`lesson_${level}_${i}`) === 'done') {
            totalCompleted++;
          }
        }
      }
    });
    
    const percent = totalLessons > 0 ? Math.round(totalCompleted / totalLessons * 100) : 0;
    
    // Update header progress
    document.getElementById('header-progress-text').innerText = percent + '%';
    document.getElementById('header-progress-fill').style.width = percent + '%';
  }

  function speak(text) {
    if (!('speechSynthesis' in window)) {
      alert('Ova funkcija nije podr≈æana u va≈°em browseru.');
      return;
    }
    
    try {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'en-US';
      utter.rate = 0.6;
      utter.pitch = 1;
      utter.volume = 1;
      
      utter.onerror = (event) => {
        console.error('Speech synthesis error:', event);
        alert('Gre≈°ka pri reprodukciji zvuka.');
      };
      
      window.speechSynthesis.speak(utter);
    } catch (error) {
      console.error('Speech synthesis error:', error);
      alert('Gre≈°ka pri reprodukciji zvuka.');
    }
  }

  function createLesson(index, lesson) {
    const div = document.createElement('div');
    div.className = 'lesson-card';
    div.style.cssText = `
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid #e5e7eb;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    `;
    
    // Check if lesson is completed
    if (localStorage.getItem(`lesson_${currentLevel}_${index}`) === 'done') {
      div.style.borderColor = '#10b981';
      div.style.background = 'linear-gradient(135deg, #f0fdf4, #dcfce7)';
    }
    
    div.onmouseenter = () => {
      div.style.transform = 'translateY(-4px)';
      div.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.15)';
    };
    
    div.onmouseleave = () => {
      div.style.transform = 'translateY(0)';
      div.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.05)';
    };
    
    // Create lesson icon and title
    const icon = document.createElement('div');
    icon.style.cssText = `
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: 1rem;
    `;
    
    // Assign specific icons based on lesson title
    const getLessonIcon = (title) => {
      const titleLower = title.toLowerCase();
      
      if (titleLower.includes('pozdrav') || titleLower.includes('predstavljanje')) return 'üëã';
      if (titleLower.includes('restoran') || titleLower.includes('restoranu')) return 'üçΩÔ∏è';
      if (titleLower.includes('aerodrom') || titleLower.includes('aerodromu')) return '‚úàÔ∏è';
      if (titleLower.includes('hotel') || titleLower.includes('hotelu')) return 'üè®';
      if (titleLower.includes('kupovina') || titleLower.includes('kupovini')) return 'üõçÔ∏è';
      if (titleLower.includes('hitne') || titleLower.includes('situacije')) return 'üö®';
      if (titleLower.includes('prevoz') || titleLower.includes('transport')) return 'üöå';
      if (titleLower === 'brojevi i vreme') return 'üïê';
      if (titleLower === 'vremenske prilike') return 'üå§Ô∏è';
      if (titleLower.includes('zdravlje') || titleLower.includes('zdravlja')) return 'üè•';
      if (titleLower.includes('pitanja') || titleLower.includes('postavljanje')) return '‚ùì';
      if (titleLower.includes('banka') || titleLower.includes('banci')) return 'üè¶';
      if (titleLower.includes('prodavnica') || titleLower.includes('prodavnici')) return 'üõí';
      if (titleLower.includes('ulica') || titleLower.includes('ulici')) return 'üó∫Ô∏è';
      if (titleLower.includes('pla≈æa') || titleLower.includes('pla≈æi')) return 'üèñÔ∏è';
      
      // Fallback icons for other cases
      return 'üìö';
    };
    
    icon.textContent = getLessonIcon(lesson.title);
    
    const title = document.createElement('h3');
    title.textContent = lesson.title;
    title.style.cssText = `
      margin: 0;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      color: #1f2937;
    `;
    
    const phraseCount = document.createElement('div');
    phraseCount.textContent = `${lesson.phrases.length} fraza`;
    phraseCount.style.cssText = `
      text-align: center;
      color: #6b7280;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    `;
    
    // Add completion indicator
    if (localStorage.getItem(`lesson_${currentLevel}_${index}`) === 'done') {
      const completed = document.createElement('div');
      completed.innerHTML = '‚úÖ Zavr≈°eno';
      completed.style.cssText = `
        text-align: center;
        color: #10b981;
        font-weight: 600;
        margin-top: 0.5rem;
        font-size: 0.9rem;
      `;
      div.appendChild(completed);
    }
    
    div.appendChild(icon);
    div.appendChild(title);
    div.appendChild(phraseCount);
    
    // Click to open lesson modal
    div.onclick = () => {
      showLessonModal(index, lesson);
    };
    
    document.querySelector('.lessons-grid').appendChild(div);
  }

  function showLessonModal(index, lesson) {
    // Create modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    modalOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    `;

    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content';
    modalContent.style.maxWidth = '600px';
    modalContent.style.width = '90vw';
    
    // Create modal header
    const modalHeader = document.createElement('div');
    modalHeader.className = 'modal-header';
    modalHeader.innerHTML = `
      <div class="modal-title">${lesson.title}</div>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
    `;
    
    // Create modal body
    const modalBody = document.createElement('div');
    modalBody.className = 'modal-body';
    
    // Add phrases
    lesson.phrases.forEach(p => {
      const pDiv = document.createElement('div');
      pDiv.className = 'phrase';
      pDiv.style.cssText = `
        background: #f9fafb;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
      `;
      
      const engText = document.createElement('strong');
      engText.textContent = p.eng;
      engText.style.cssText = 'font-size: 1.1rem; color: #1f2937; display: block; margin-bottom: 0.5rem;';
      
      const srText = document.createElement('div');
      srText.textContent = p.sr;
      srText.style.cssText = 'color: #374151; margin-bottom: 0.5rem;';
      
      const pronText = document.createElement('em');
      pronText.textContent = p.pron;
      pronText.style.cssText = 'color: #6b7280; font-size: 0.9rem; display: block; margin-bottom: 1rem;';
      
      const buttonsDiv = document.createElement('div');
      buttonsDiv.style.cssText = 'display: flex; gap: 0.5rem;';
      
      const listenBtn = document.createElement('button');
      listenBtn.innerHTML = 'üîä Slu≈°aj';
      listenBtn.className = 'btn listen-btn';
      listenBtn.style.cssText = 'flex: 1;';
      listenBtn.onclick = (e) => {
        e.stopPropagation();
        speak(p.eng);
      };
      
      const pronBtn = document.createElement('button');
      pronBtn.innerHTML = 'üé§ Proveri';
      pronBtn.className = 'btn';
      pronBtn.style.cssText = `
        flex: 1;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
      `;
      pronBtn.onclick = (e) => {
        e.stopPropagation();
        checkPronunciation(p.eng);
      };
      
      buttonsDiv.appendChild(listenBtn);
      buttonsDiv.appendChild(pronBtn);
      
      pDiv.appendChild(engText);
      pDiv.appendChild(srText);
      pDiv.appendChild(pronText);
      pDiv.appendChild(buttonsDiv);
      modalBody.appendChild(pDiv);
    });
    
    // Add quiz button
    const quizBtn = document.createElement('button');
    quizBtn.innerHTML = 'ÔøΩÔøΩ Zapoƒçni kviz';
    quizBtn.className = 'btn quiz-btn';
    quizBtn.style.cssText = `
      width: 100%;
      margin-top: 1rem;
      padding: 1rem;
      font-size: 1.1rem;
    `;
    quizBtn.onclick = (e) => {
      e.stopPropagation();
      modalOverlay.remove(); // Close lesson modal first
      startQuiz(index, lesson, currentLevel); // Start quiz in new modal
    };
    
    modalBody.appendChild(quizBtn);
    
    // Append header and body to modal content
    modalContent.appendChild(modalHeader);
    modalContent.appendChild(modalBody);
    modalOverlay.appendChild(modalContent);
    
    // Close modal when clicking outside
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) {
        modalOverlay.remove();
      }
    });
    
    // Add modal to body
    document.body.appendChild(modalOverlay);
  }

  function startQuiz(index, lesson, level) {
    // Create modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content menu-modal';
    modalContent.style.maxWidth = '400px';
    
    // Create modal header
    const modalHeader = document.createElement('div');
    modalHeader.className = 'modal-header';
    modalHeader.innerHTML = `
      <div class="modal-title">üéØ Kviz: ${lesson.title}</div>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
    `;
    
    // Create modal body
    const modalBody = document.createElement('div');
    modalBody.className = 'modal-body';
    
    // Append header and body to modal content
    modalContent.appendChild(modalHeader);
    modalContent.appendChild(modalBody);
    modalOverlay.appendChild(modalContent);
    
    // Add modal to body
    document.body.appendChild(modalOverlay);
    
    // Close modal when clicking outside
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) {
        modalOverlay.remove();
      }
    });

    let correct = 0;
    let current = 0;
    const total = 5;
    const used = [];
    const options = lesson.phrases.slice();

    function showQuestion() {
      if (current >= total) {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'quiz-result';
        
        // Determine result class based on score
        if (correct >= 4) {
          resultDiv.classList.add('excellent');
          resultDiv.innerHTML = `
            üéâ Odliƒçno! Rezultat: <strong>${correct}/${total}</strong>
            <div class="quiz-feedback">Svaka ƒçast! Uspe≈°no ste zavr≈°ili lekciju.</div>
          `;
          localStorage.setItem(`lesson_${level}_${index}`, 'done');
          updateProgress(lessonCount);
          updateMenuStats(); // A≈æuriraj statistiku u meniju
          loadLessons(currentLevel); // Osve≈æi prikaz lekcija
          updateLevelCompletionIndicators(); // Update level indicators
          // location.reload(); // uklonjeno
        } else if (correct >= 3) {
          resultDiv.classList.add('good');
          resultDiv.innerHTML = `
            üëç Dobro! Rezultat: <strong>${correct}/${total}</strong>
            <div class="quiz-feedback">Skoro ste uspeli! Poku≈°ajte ponovo za bolji rezultat.</div>
          `;
        } else {
          resultDiv.classList.add('poor');
          resultDiv.innerHTML = `
            üòî Rezultat: <strong>${correct}/${total}</strong>
            <div class="quiz-feedback">Potrebno je vi≈°e ve≈æbanja. Poku≈°ajte ponovo!</div>
          `;
        }
        
        modalBody.innerHTML = '';
        modalBody.appendChild(resultDiv);
        
        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Zatvori kviz';
        closeBtn.className = 'quiz-close-btn';
        closeBtn.onclick = () => {
          modalOverlay.remove();
        };
        modalBody.appendChild(closeBtn);
        
        return;
      }

      let q;
      do {
        q = options[Math.floor(Math.random() * options.length)];
      } while (used.includes(q.eng));
      used.push(q.eng);

      const answers = [q.sr];
      while (answers.length < 4) {
        const fake = options[Math.floor(Math.random() * options.length)].sr;
        if (!answers.includes(fake)) answers.push(fake);
      }
      answers.sort(() => Math.random() - 0.5);

      modalBody.innerHTML = '';
      
      // Add quiz header with progress
      const headerDiv = document.createElement('div');
      headerDiv.className = 'quiz-header';
      headerDiv.innerHTML = `
        <div class="quiz-title">Pitanje ${current + 1} od ${total}</div>
        <div class="quiz-progress">${correct} taƒçnih</div>
      `;
      modalBody.appendChild(headerDiv);
      
      const questionDiv = document.createElement('div');
      questionDiv.className = 'quiz-question';
      questionDiv.innerHTML = `<strong>${q.eng}</strong>`;
      modalBody.appendChild(questionDiv);
      
      const optionsDiv = document.createElement('div');
      optionsDiv.className = 'quiz-options';
      
      answers.forEach(ans => {
        const btn = document.createElement('button');
        btn.textContent = ans;
        btn.className = 'quiz-option';
        btn.onclick = () => {
          // A≈æuriraj statistiku kvizova
          let quizStats = JSON.parse(localStorage.getItem('quizStats') || '{}');
          quizStats.answered = (quizStats.answered || 0) + 1;
          if (ans === q.sr) {
            correct++;
            quizStats.correct = (quizStats.correct || 0) + 1;
            btn.classList.add('correct');
          } else {
            btn.classList.add('incorrect');
          }
          localStorage.setItem('quizStats', JSON.stringify(quizStats));
          // Disable all buttons and add disabled class
          document.querySelectorAll('.quiz-option').forEach(option => {
            option.classList.add('disabled');
            option.style.pointerEvents = 'none';
          });
          // Update progress in header
          const progressDiv = modalBody.querySelector('.quiz-progress');
          if (progressDiv) {
            progressDiv.textContent = `${correct} taƒçnih`;
          }
          setTimeout(() => {
            current++;
            showQuestion();
          }, 1500);
        };
        optionsDiv.appendChild(btn);
      });
      
      modalBody.appendChild(optionsDiv);
    }

    showQuestion();
  }

  let lessonCount = 0;
  let currentLevel = 'beginner';
  let lessonsData = {};

  // Function to select level
  function selectLevel(level) {
    currentLevel = level;
    
    // Update active button
    document.querySelectorAll('.level-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Add completion indicator to level buttons
    updateLevelCompletionIndicators();
    
    // Load lessons for selected level
    loadLessons(level);
    
    // Update level completion indicators after loading lessons
    setTimeout(() => {
      updateLevelCompletionIndicators();
    }, 500);
  }

  // Function to update level completion indicators
  function updateLevelCompletionIndicators() {
    const levels = ['beginner', 'intermediate', 'advanced'];
    levels.forEach(level => {
      const btn = document.querySelector(`[onclick="selectLevel('${level}')"]`);
      if (btn) {
        // Remove existing completion indicator
        const existingIndicator = btn.querySelector('.level-completion-indicator');
        if (existingIndicator) {
          existingIndicator.remove();
        }
        
        // Add completion indicator if level is completed
        if (isLevelCompleted(level)) {
          const indicator = document.createElement('span');
          indicator.className = 'level-completion-indicator';
          indicator.innerHTML = 'üèÜ';
          indicator.style.cssText = `
            position: absolute;
            top: -5px;
            right: -5px;
            background: #10b981;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          `;
          btn.style.position = 'relative';
          btn.appendChild(indicator);
        }
      }
    });
  }

  // Function to load lessons for specific level
  function loadLessons(level) {
    const levelFiles = {
      'beginner': 'lessons.json',
      'intermediate': 'lessons_intermediate.json',
      'advanced': 'lessons_advanced.json'
    };

    const fileName = levelFiles[level];
    
    fetch(fileName + '?v=' + Date.now())
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        lessonsData[level] = data;
        lessonCount = data.length;
        document.getElementById('lessons').innerHTML = '';
        
        const lessonsGrid = document.createElement('div');
        lessonsGrid.className = 'lessons-grid';
        lessonsGrid.style.cssText = `
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 1.5rem;
          padding: 1rem;
        `;
        
        document.getElementById('lessons').appendChild(lessonsGrid);
        
        data.forEach((lesson, i) => createLesson(i, lesson));
        updateProgress(lessonCount);
        
        // Check if all lessons are completed and show advanced quiz button
        if (areAllLessonsCompleted(level) && !isLevelCompleted(level)) {
          const advancedQuizBtn = document.createElement('button');
          advancedQuizBtn.innerHTML = 'üèÜ Napredni kviz nivoa (20 pitanja)';
          advancedQuizBtn.className = 'btn';
          advancedQuizBtn.style.cssText = `
            width: 100%;
            margin-top: 2rem;
            padding: 1.5rem;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
            transition: all 0.3s ease;
          `;
          
          advancedQuizBtn.onmouseenter = () => {
            advancedQuizBtn.style.transform = 'translateY(-2px)';
            advancedQuizBtn.style.boxShadow = '0 12px 35px rgba(245, 158, 11, 0.4)';
          };
          
          advancedQuizBtn.onmouseleave = () => {
            advancedQuizBtn.style.transform = 'translateY(0)';
            advancedQuizBtn.style.boxShadow = '0 8px 25px rgba(245, 158, 11, 0.3)';
          };
          
          advancedQuizBtn.onclick = () => {
            startAdvancedQuiz(level);
          };
          
          document.querySelector('.lessons-grid').appendChild(advancedQuizBtn);
        }
        
        // Update level completion indicators
        updateLevelCompletionIndicators();
        
        // showPhraseOfDay(data); // uklonjeno na zahtev korisnika
      })
      .catch(err => {
        console.error('Error loading lessons:', err);
        document.getElementById('lessons').innerHTML = '<div class="error">‚ùå Gre≈°ka pri uƒçitavanju lekcija. Molimo poku≈°ajte ponovo.</div>';
      });
  }

  // Initialize with beginner level
  document.addEventListener('DOMContentLoaded', function() {
    // Set beginner as active by default
    document.querySelector('.level-btn').classList.add('active');
    loadLessons('beginner');
    
    // Update level completion indicators
    setTimeout(() => {
      updateLevelCompletionIndicators();
    }, 1000); // Wait for lessons to load
    
    // Check for app updates
    checkForUpdates();
    
    // Listen for service worker messages
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', event => {
        if (event.data && event.data.type === 'SW_ACTIVATED') {
          console.log('Service Worker activated, checking for updates...');
          checkForUpdates();
        }
      });
    }
  });

  // Menu modal functionality
  function showMenu() {
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content menu-modal';
    modalContent.style.maxWidth = '400px';
    
    const modalHeader = document.createElement('div');
    modalHeader.className = 'modal-header';
    modalHeader.innerHTML = `
      <div class="modal-title">‚öôÔ∏è Pode≈°avanja</div>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
    `;
    
    const modalBody = document.createElement('div');
    modalBody.className = 'modal-body';
    modalBody.innerHTML = `
      <div style="margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 1rem;">üé® Izgled</h3>
        <button id="dark-mode-toggle" class="btn" style="width: 100%; margin-bottom: 0.5rem; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;">
          ${document.body.classList.contains('dark') ? '‚òÄÔ∏è Svetli re≈æim' : 'üåô Noƒáni re≈æim'}
        </button>
        <button id="reset-progress-btn" class="btn" style="width: 100%; margin-bottom: 0.5rem; background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
          ‚ôªÔ∏è Resetuj napredak
        </button>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 1rem;">üì± Instalacija</h3>
        <button id="show-install-btn" class="btn" style="width: 100%; margin-bottom: 0.5rem; background: linear-gradient(135deg, #10b981, #059669); color: white;">
          üì± Instaliraj aplikaciju
        </button>
        <div id="install-status" style="background: #f3f4f6; padding: 0.8rem; border-radius: 8px; text-align: center; font-size: 0.85rem; color: #6b7280;">
          Proveravam status instalacije...
        </div>
        <p style="color: #6b7280; font-size: 0.8rem; text-align: center;">
          Instalirajte aplikaciju za br≈æi pristup i offline funkcionalnost
        </p>
      </div>
      <div>
        <h3 style="margin-bottom: 1rem;">‚ÑπÔ∏è O aplikaciji</h3>
        <p style="color: #6b7280; font-size: 0.9rem;">
          PutujGovori - Aplikacija za uƒçenje engleskog jezika namenjena putnicima.
          <br><br>
          Verzija: 2.0<br>
          PWA kompatibilna
        </p>
      </div>
    `;
    
    modalContent.appendChild(modalHeader);
    modalContent.appendChild(modalBody);
    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);
    
    // Update stats in menu
    updateMenuStats();
    
    // Update installation status in menu
    updateInstallStatus();
    
    // Dark mode toggle in menu
    document.getElementById('dark-mode-toggle').onclick = () => {
      setDarkMode(!document.body.classList.contains('dark'));
      document.getElementById('dark-mode-toggle').innerHTML = 
        document.body.classList.contains('dark') ? '‚òÄÔ∏è Svetli re≈æim' : 'üåô Noƒáni re≈æim';
    };
    
    // Show install button from menu
    document.getElementById('show-install-btn').onclick = () => {
      modalOverlay.remove(); // Close menu first
      
      // Check installation status
      const status = checkInstallationStatus();
      
      if (status.isInstalled) {
        showSuccessModal('‚úÖ Aplikacija je veƒá instalirana i pokrenuta kao standalone aplikacija!');
        return;
      }
      
      if (!status.canInstall) {
        let message = '';
        switch (status.reason) {
          case 'not_https':
            message = '‚ö†Ô∏è Instalacija zahteva HTTPS konekciju. Trenutno ste na: ' + location.protocol + '//' + location.hostname;
            break;
          case 'no_service_worker':
            message = '‚ùå Instalacija nije podr≈æana u va≈°em browseru. Poku≈°ajte sa Chrome ili Edge.';
            break;
          default:
            message = '‚ÑπÔ∏è Instalacija trenutno nije dostupna. Poku≈°ajte ponovo kasnije.';
        }
        showSuccessModal(message);
        return;
      }
      
      // Directly trigger install prompt
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the install prompt');
            showSuccessModal('üéâ Aplikacija je uspe≈°no instalirana! Mo≈æete je pokrenuti sa desktop-a ili iz menija aplikacija.');
          } else {
            console.log('User dismissed the install prompt');
            showSuccessModal('‚ÑπÔ∏è Instalacija je otkazana. Mo≈æete poku≈°ati ponovo kasnije.');
          }
          deferredPrompt = null;
        });
      } else {
        showSuccessModal('‚ÑπÔ∏è Instalacija trenutno nije dostupna. Poku≈°ajte:\n\n1. Osve≈æite stranicu\n2. Koristite Chrome ili Edge browser\n3. Saƒçekajte nekoliko sekundi i poku≈°ajte ponovo');
      }
    };
    
    // Close modal when clicking outside
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) {
        modalOverlay.remove();
      }
    });

    // Reset progress logic
    setTimeout(() => {
      const resetBtn = document.getElementById('reset-progress-btn');
      if (resetBtn) {
        resetBtn.onclick = () => {
          showResetModal();
        };
      }
    }, 500);
  }

  function updateMenuStats() {
    // Broji zavr≈°ene lekcije iz svih nivoa
    let totalCompleted = 0;
    let totalLessons = 0;
    
    // Proveri sve nivoe
    const levels = ['beginner', 'intermediate', 'advanced'];
    levels.forEach(level => {
      if (lessonsData[level]) {
        const levelLessons = lessonsData[level].length;
        totalLessons += levelLessons;
        
        // Broji zavr≈°ene lekcije za ovaj nivo
        for (let i = 0; i < levelLessons; i++) {
          if (localStorage.getItem(`lesson_${level}_${i}`) === 'done') {
            totalCompleted++;
          }
        }
      } else {
        // Ako nivo nije uƒçitan, dodaj default broj lekcija (15 za svaki nivo)
        totalLessons += 15;
        
        // Broji zavr≈°ene lekcije za ovaj nivo iz localStorage
        for (let i = 0; i < 15; i++) {
          if (localStorage.getItem(`lesson_${level}_${i}`) === 'done') {
            totalCompleted++;
          }
        }
      }
    });
    
    const quizData = JSON.parse(localStorage.getItem('quizStats')||'{}');
    const totalAnswered = quizData.answered||0;
    const totalCorrect = quizData.correct||0;
    const accuracy = totalAnswered ? Math.round(100*totalCorrect/totalAnswered) : 0;
    
    if (document.getElementById('completed-lessons')) {
      document.getElementById('completed-lessons').textContent = totalCompleted;
      document.getElementById('total-lessons').textContent = totalLessons;
      document.getElementById('quiz-accuracy').textContent = accuracy + '%';
    }
  }

  function updateInstallStatus() {
    const statusElement = document.getElementById('install-status');
    if (!statusElement) return;
    
    const status = checkInstallationStatus();
    
    if (status.isInstalled) {
      statusElement.innerHTML = '‚úÖ <strong>Aplikacija je instalirana</strong><br>Pokrenuta kao standalone aplikacija';
      statusElement.style.background = '#dcfce7';
      statusElement.style.color = '#166534';
    } else if (status.canInstall) {
      if (deferredPrompt) {
        statusElement.innerHTML = 'üì± <strong>Instalacija dostupna</strong><br>Kliknite dugme iznad za instalaciju';
        statusElement.style.background = '#dbeafe';
        statusElement.style.color = '#1e40af';
      } else {
        statusElement.innerHTML = '‚è≥ <strong>Priprema instalacije</strong><br>Saƒçekajte nekoliko sekundi';
        statusElement.style.background = '#fef3c7';
        statusElement.style.color = '#92400e';
      }
    } else {
      switch (status.reason) {
        case 'not_https':
          statusElement.innerHTML = '‚ö†Ô∏è <strong>HTTPS potreban</strong><br>Instalacija zahteva sigurnu konekciju';
          statusElement.style.background = '#fef3c7';
          statusElement.style.color = '#92400e';
          break;
        case 'no_service_worker':
          statusElement.innerHTML = '‚ùå <strong>Browser ne podr≈æava</strong><br>Koristite Chrome ili Edge';
          statusElement.style.background = '#fee2e2';
          statusElement.style.color = '#991b1b';
          break;
        default:
          statusElement.innerHTML = '‚ÑπÔ∏è <strong>Instalacija nedostupna</strong><br>Poku≈°ajte ponovo kasnije';
          statusElement.style.background = '#f3f4f6';
          statusElement.style.color = '#6b7280';
      }
    }
  }

  // Dark mode logic
  function setDarkMode(on) {
    if (on) {
      document.body.classList.add('dark');
      localStorage.setItem('darkMode', '1');
    } else {
      document.body.classList.remove('dark');
      localStorage.setItem('darkMode', '0');
    }
    
    // Update install button styles for dark mode
    const installButton = document.getElementById('install-button');
    if (installButton) {
      if (on) {
        installButton.style.background = 'linear-gradient(135deg, #818cf8, #6366f1)';
        installButton.style.boxShadow = '0 8px 25px rgba(129, 140, 248, 0.3)';
      } else {
        installButton.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
        installButton.style.boxShadow = '0 8px 25px rgba(99, 102, 241, 0.3)';
      }
    }
  }

  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

  document.getElementById('menu-btn').onclick = () => {
    showMenu();
  };

  function showPhraseOfDay(lessons) {
    console.log('Prikazujem frazu dana');
    
    const allPhrases = lessons.flatMap(l=>l.phrases.map(p=>({...p, lesson:l.title})));
    const idx = Math.floor(Math.random()*allPhrases.length);
    const p = allPhrases[idx];
    
    const phraseElement = document.getElementById('phrase-of-day');
    const lessonsElement = document.getElementById('lessons');
    
    phraseElement.style.display = 'block';
    lessonsElement.style.display = 'none'; // Sakrij lekcije kada je fraza dana aktivna
    
    phraseElement.innerHTML = `
      <div class='phrase' style='display:inline-block;max-width:400px;position:relative;'>
        <button onclick="closePhraseOfDay()" style="position:absolute;top:-10px;right:-10px;background:#ef4444;color:white;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;font-size:14px;font-weight:bold;box-shadow:0 2px 4px rgba(0,0,0,0.2);">√ó</button>
        <strong>Fraza dana</strong><br>
        <span style='font-size:1.2rem;'>${p.eng}</span>
        <div>${p.sr}</div>
        <em>${p.pron}</em>
        <div style='margin-top:0.5rem;'>
          <button class='listen-btn' onclick='speakAndHide("${p.eng.replace(/'/g,"\\'")}")' title='Slu≈°aj izgovor'>üîä</button>
          <button onclick="checkPronunciation('${p.eng.replace(/'/g,"\\'")}')" class="btn" style="background: linear-gradient(135deg, #10b981, #059669); color: white; margin-left: 0.5rem;">
            üé§
          </button>
        </div>
      </div>`;
    
    console.log('Fraza dana prikazana');
  }

  function closePhraseOfDay() {
    const phraseElement = document.getElementById('phrase-of-day');
    const lessonsElement = document.getElementById('lessons');
    
    phraseElement.style.display = 'none';
    lessonsElement.style.display = 'block'; // Prika≈æi lekcije kada se fraza dana zatvori
  }

  function speakAndHide(text) {
    speak(text);
  }

  function checkPronunciation(expectedText) {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert('Speech recognition nije podr≈æan u va≈°em browseru. Poku≈°ajte sa Chrome ili Edge.');
      return;
    }

    // Check if we're on HTTPS or localhost (required for microphone access)
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      alert('Za pristup mikrofonu potrebna je HTTPS konekcija ili localhost. Trenutno ste na: ' + location.protocol + '//' + location.hostname);
      return;
    }

    // Show loading modal first
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    modalOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    `;

    const loadingModal = document.createElement('div');
    loadingModal.className = 'speech-modal';
    loadingModal.innerHTML = `
      <h3>üé§ Priprema mikrofon...</h3>
      <p>Molimo saƒçekajte dok se priprema mikrofon.</p>
      <div style="margin:1rem 0;">
        <div style="width:40px;height:40px;border:4px solid #e5e7eb;border-top:4px solid #3b82f6;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;"></div>
      </div>
    `;
    
    modalOverlay.appendChild(loadingModal);
    document.body.appendChild(modalOverlay);

    // Try to get microphone permission
    navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true
      } 
    })
      .then(function(stream) {
        // Permission granted, remove loading and start recognition
        modalOverlay.remove();
        startSpeechRecognition(expectedText);
        // Stop the stream since we only needed permission
        stream.getTracks().forEach(track => track.stop());
      })
      .catch(function(err) {
        console.error('Microphone error:', err);
        
        let errorMessage = 'Problem sa pristupom mikrofonu.';
        
        switch(err.name) {
          case 'NotAllowedError':
            errorMessage = 'Dozvola za mikrofon je odbijena. Molimo dozvolite pristup mikrofonu u pode≈°avanjima browsera i poku≈°ajte ponovo.';
            break;
          case 'NotFoundError':
            errorMessage = 'Mikrofon nije pronaƒëen. Proverite da li je mikrofon povezan i radi.';
            break;
          case 'NotReadableError':
            errorMessage = 'Mikrofon se koristi u drugoj aplikaciji. Zatvorite druge aplikacije koje koriste mikrofon.';
            break;
          case 'OverconstrainedError':
            errorMessage = 'Mikrofon ne podr≈æava tra≈æene pode≈°avanja.';
            break;
          default:
            errorMessage = `Gre≈°ka: ${err.message || err.name}`;
        }
        
        // Show error modal with retry option
        const errorModal = document.createElement('div');
        errorModal.className = 'speech-modal';
        errorModal.innerHTML = `
          <h3>‚ùå Problem sa mikrofonom</h3>
          <p style="color:#ef4444;margin:1rem 0;">${errorMessage}</p>
          <div style="margin-top:1rem;">
            <button onclick="this.closest('.modal-overlay').remove(); checkPronunciation('${expectedText.replace(/'/g,"\\'")}')" style="background:#3b82f6;color:white;border:none;padding:0.5rem 1rem;border-radius:8px;cursor:pointer;margin-right:0.5rem;">Poku≈°aj ponovo</button>
            <button onclick="this.closest('.modal-overlay').remove()" style="background:#ef4444;color:white;border:none;padding:0.5rem 1rem;border-radius:8px;cursor:pointer;">Zatvori</button>
          </div>
        `;
        
        modalOverlay.innerHTML = '';
        modalOverlay.appendChild(errorModal);
      });
  }

  function startSpeechRecognition(expectedText) {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;

    // Create modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    modalOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    `;

    const resultDiv = document.createElement('div');
    resultDiv.className = 'speech-modal';
    resultDiv.innerHTML = `
      <h3>üé§ Izgovorite frazu</h3>
      <p><strong>Oƒçekivano:</strong> ${expectedText}</p>
      <div id="recognition-result" style="margin:1rem 0;padding:1rem;background:#f3f4f6;border-radius:8px;min-height:60px;">
        <p style="color:#6b7280;">Snimanje poƒçinje...</p>
      </div>
      <div id="timer-info" style="margin-top:0.5rem;color:#6366f1;font-weight:600;text-align:center;"></div>
      <div style="margin-top:1rem;">
        <button onclick="this.closest('.modal-overlay').remove()" style="background:#ef4444;color:white;border:none;padding:0.5rem 1rem;border-radius:8px;cursor:pointer;">Zatvori</button>
      </div>
    `;
    modalOverlay.appendChild(resultDiv);
    document.body.appendChild(modalOverlay);

    let finalTranscript = '';
    let interimTranscript = '';
    let recognitionStarted = false;
    let timer = null;
    let timeLeft = 10;
    const timerInfo = resultDiv.querySelector('#timer-info');
    let silenceTimer = null;
    const SILENCE_LIMIT = 2000; // 2 sekunde

    function resetSilenceTimer() {
      if (silenceTimer) clearTimeout(silenceTimer);
      silenceTimer = setTimeout(() => {
        stopRecognition(true); // true = ti≈°ina
      }, SILENCE_LIMIT);
    }

    function startRecognition() {
      try {
        recognition.start();
        recognitionStarted = true;
        document.getElementById('recognition-result').innerHTML = '<p style="color:#6b7280;">Slu≈°am... Govorite sada!</p>';
        timeLeft = 10;
        timerInfo.textContent = `‚è±Ô∏è Preostalo vreme: ${timeLeft}s`;
        timer = setInterval(() => {
          timeLeft--;
          if (timeLeft > 0) {
            timerInfo.textContent = `‚è±Ô∏è Preostalo vreme: ${timeLeft}s`;
          } else {
            timerInfo.textContent = '‚è±Ô∏è Vreme za snimanje je isteklo.';
            stopRecognition(false);
          }
        }, 1000);
        resetSilenceTimer();
      } catch (error) {
        document.getElementById('recognition-result').innerHTML = `<p style=\"color:#ef4444;\">Gre≈°ka pri pokretanju snimanja.</p>`;
      }
    }

    function stopRecognition(isSilence) {
      if (timer) clearInterval(timer);
      if (silenceTimer) clearTimeout(silenceTimer);
      recognition.stop();
      recognitionStarted = false;
      if (isSilence) {
        timerInfo.textContent = '‚è±Ô∏è Snimanje je prekinuto zbog ti≈°ine.';
        document.getElementById('recognition-result').innerHTML += '<p style="color:#ef4444;">Nije detektovan govor du≈æe od 2 sekunde.</p>';
      }
    }

    recognition.onstart = function() {
      // UI veƒá a≈æuriran u startRecognition
    };

    recognition.onresult = function(event) {
      resetSilenceTimer();
      interimTranscript = '';
      finalTranscript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalTranscript += transcript;
        } else {
          interimTranscript += transcript;
        }
      }
      const resultElement = document.getElementById('recognition-result');
      if (finalTranscript) {
        const accuracy = calculateSimilarity(finalTranscript.toLowerCase(), expectedText.toLowerCase());
        resultElement.innerHTML = `
          <p><strong>Rekli ste:</strong> ${finalTranscript}</p>
          <p><strong>Taƒçnost:</strong> ${accuracy}%</p>
          <p style="color:${accuracy > 70 ? '#10b981' : '#ef4444'};font-weight:bold;">
            ${accuracy > 70 ? 'Odliƒçno! üéâ' : 'Poku≈°ajte ponovo! üí™'}
          </p>
        `;
        stopRecognition(false);
      } else if (interimTranscript) {
        resultElement.innerHTML = `
          <p><strong>ƒåujem:</strong> ${interimTranscript}</p>
          <p style="color:#6b7280;font-size:0.9rem;">Nastavite govoriti...</p>
        `;
      }
    };

    recognition.onerror = function(event) {
      if (silenceTimer) clearTimeout(silenceTimer);
      const resultElement = document.getElementById('recognition-result');
      let errorMessage = 'Gre≈°ka pri prepoznavanju govora.';
      switch(event.error) {
        case 'no-speech':
          errorMessage = 'Nije detektovan govor. Poku≈°ajte ponovo i govorite jasnije.';
          break;
        case 'audio-capture':
          errorMessage = 'Problem sa mikrofonom. Proverite dozvole i poku≈°ajte ponovo.';
          break;
        case 'not-allowed':
          errorMessage = 'Dozvola za mikrofon je potrebna. Proverite pode≈°avanja browsera.';
          break;
        case 'network':
          errorMessage = 'Problem sa mre≈æom. Proverite internet konekciju.';
          break;
        case 'service-not-allowed':
          errorMessage = 'Speech recognition servis nije dozvoljen.';
          break;
        case 'bad-grammar':
          errorMessage = 'Problem sa gramatikom.';
          break;
        case 'language-not-supported':
          errorMessage = 'Jezik nije podr≈æan.';
          break;
        default:
          errorMessage = `Gre≈°ka: ${event.error}`;
      }
      resultElement.innerHTML = `
        <p style=\"color:#ef4444;\">${errorMessage}</p>
        <p style=\"color:#6b7280;font-size:0.9rem;\">Mo≈æete proveriti izgovor slu≈°anjem originala.</p>
        <button onclick=\"speak('${expectedText.replace(/'/g,"\\'")}')\" style=\"background:#3b82f6;color:white;border:none;padding:0.5rem 1rem;border-radius:8px;cursor:pointer;margin-top:0.5rem;\">üîä Slu≈°aj original</button>
      `;
      stopRecognition(false);
    };

    recognition.onend = function() {
      recognitionStarted = false;
      if (timer) clearInterval(timer);
      if (silenceTimer) clearTimeout(silenceTimer);
      if (!timerInfo.textContent.includes('prekinuto')) {
        timerInfo.textContent = '‚è±Ô∏è Snimanje je zavr≈°eno.';
      }
    };

    // Pokreni snimanje automatski
    setTimeout(() => {
      startRecognition();
    }, 400);
  }

  function calculateSimilarity(str1, str2) {
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;
    
    if (longer.length === 0) return 100;
    
    const editDistance = levenshteinDistance(longer, shorter);
    return Math.round((1 - editDistance / longer.length) * 100);
  }

  function levenshteinDistance(str1, str2) {
    const matrix = [];
    for (let i = 0; i <= str2.length; i++) {
      matrix[i] = [i];
    }
    for (let j = 0; j <= str1.length; j++) {
      matrix[0][j] = j;
    }
    for (let i = 1; i <= str2.length; i++) {
      for (let j = 1; j <= str1.length; j++) {
        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
          matrix[i][j] = matrix[i - 1][j - 1];
        } else {
          matrix[i][j] = Math.min(
            matrix[i - 1][j - 1] + 1,
            matrix[i][j - 1] + 1,
            matrix[i - 1][j] + 1
          );
        }
      }
    }
    return matrix[str2.length][str1.length];
  }

  // Splash Screen functionality
  function hideSplashScreen() {
    const splashScreen = document.getElementById('splash-screen');
    const mainContent = document.getElementById('main-content');
    
    // Fade out splash screen
    splashScreen.classList.add('fade-out');
    
    // Show main content
    mainContent.classList.add('show');
    
    // Remove splash screen after animation
    setTimeout(() => {
      splashScreen.remove();
    }, 500);
  }

  // Initialize splash screen
  document.addEventListener('DOMContentLoaded', () => {
    // Simulate loading time (5 seconds)
    setTimeout(() => {
      hideSplashScreen();
    }, 5000);
  });

  function toggleDarkMode() {
    const body = document.body;
    const isDark = body.classList.toggle('dark');
    
    // Update install button styles for dark mode
    const installButton = document.getElementById('install-button');
    if (installButton) {
      if (isDark) {
        installButton.style.background = 'linear-gradient(135deg, #818cf8, #6366f1)';
        installButton.style.boxShadow = '0 8px 25px rgba(129, 140, 248, 0.3)';
      } else {
        installButton.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
        installButton.style.boxShadow = '0 8px 25px rgba(99, 102, 241, 0.3)';
      }
    }
    
    localStorage.setItem('darkMode', isDark);
  }

  // Function to check if all lessons in a level are completed
  function areAllLessonsCompleted(level) {
    if (!lessonsData[level]) return false;
    
    const totalLessons = lessonsData[level].length;
    let completedCount = 0;
    
    for (let i = 0; i < totalLessons; i++) {
      if (localStorage.getItem(`lesson_${level}_${i}`) === 'done') {
        completedCount++;
      }
    }
    
    return completedCount === totalLessons;
  }

  // Function to check if level is completed (passed advanced quiz)
  function isLevelCompleted(level) {
    return localStorage.getItem(`level_${level}_completed`) === 'true';
  }

  function startAdvancedQuiz(level) {
    // Create modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content menu-modal';
    modalContent.style.maxWidth = '500px';
    
    // Create modal header
    const modalHeader = document.createElement('div');
    modalHeader.className = 'modal-header';
    modalHeader.innerHTML = `
      <div class="modal-title">üèÜ Napredni kviz: ${level.charAt(0).toUpperCase() + level.slice(1)} nivo</div>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
    `;
    
    // Create modal body
    const modalBody = document.createElement('div');
    modalBody.className = 'modal-body';
    
    // Append header and body to modal content
    modalContent.appendChild(modalHeader);
    modalContent.appendChild(modalBody);
    modalOverlay.appendChild(modalContent);
    
    // Add modal to body
    document.body.appendChild(modalOverlay);
    
    // Close modal when clicking outside
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) {
        modalOverlay.remove();
      }
    });

    // Get all phrases from the level
    const allPhrases = [];
    lessonsData[level].forEach(lesson => {
      lesson.phrases.forEach(phrase => {
        allPhrases.push({
          ...phrase,
          lessonTitle: lesson.title
        });
      });
    });

    let correct = 0;
    let current = 0;
    const total = 20;
    const used = [];
    const selectedPhrases = [];

    // Randomly select 20 phrases
    while (selectedPhrases.length < 20 && allPhrases.length > 0) {
      const randomIndex = Math.floor(Math.random() * allPhrases.length);
      const phrase = allPhrases.splice(randomIndex, 1)[0];
      selectedPhrases.push(phrase);
    }

    function showAdvancedQuestion() {
      if (current >= total) {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'quiz-result';
        
        const percentage = Math.round((correct / total) * 100);
        
        // Determine result class based on score (80% to pass)
        if (percentage >= 80) {
          resultDiv.classList.add('excellent');
          resultDiv.innerHTML = `
            üéâ ƒåestitamo! Rezultat: <strong>${correct}/${total} (${percentage}%)</strong>
            <div class="quiz-feedback">Uspe≈°no ste zavr≈°ili ${level} nivo!</div>
            <div style="margin-top: 1rem; padding: 1rem; background: #dcfce7; border-radius: 10px; border: 2px solid #10b981;">
              <strong>üèÜ Nivo zavr≈°en!</strong><br>
              Mo≈æete nastaviti sa sledeƒáim nivoom ili ponoviti ovaj nivo.
            </div>
          `;
          localStorage.setItem(`level_${level}_completed`, 'true');
          updateProgress(lessonCount);
          loadLessons(currentLevel); // Refresh to show level completion
          updateLevelCompletionIndicators(); // Update level indicators
        } else {
          resultDiv.classList.add('poor');
          resultDiv.innerHTML = `
            üòî Rezultat: <strong>${correct}/${total} (${percentage}%)</strong>
            <div class="quiz-feedback">Potrebno je ${Math.ceil(total * 0.8)} taƒçnih odgovora (80%) da biste zavr≈°ili nivo. Poku≈°ajte ponovo!</div>
          `;
        }
        
        modalBody.innerHTML = '';
        modalBody.appendChild(resultDiv);
        
        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Zatvori kviz';
        closeBtn.className = 'quiz-close-btn';
        closeBtn.onclick = () => {
          modalOverlay.remove();
        };
        modalBody.appendChild(closeBtn);
        
        return;
      }

      const q = selectedPhrases[current];
      const answers = [q.sr];
      
      // Get 3 random wrong answers from other phrases
      const otherPhrases = selectedPhrases.filter(p => p.sr !== q.sr);
      while (answers.length < 4 && otherPhrases.length > 0) {
        const randomIndex = Math.floor(Math.random() * otherPhrases.length);
        const fake = otherPhrases.splice(randomIndex, 1)[0].sr;
        if (!answers.includes(fake)) answers.push(fake);
      }
      
      // If we don't have enough wrong answers, add some generic ones
      const genericAnswers = [
        'Ne znam',
        'Nije taƒçno',
        'Mo≈æda',
        'Verovatno ne'
      ];
      
      while (answers.length < 4) {
        const generic = genericAnswers[Math.floor(Math.random() * genericAnswers.length)];
        if (!answers.includes(generic)) answers.push(generic);
      }
      
      answers.sort(() => Math.random() - 0.5);

      modalBody.innerHTML = '';
      
      // Add quiz header with progress
      const headerDiv = document.createElement('div');
      headerDiv.className = 'quiz-header';
      headerDiv.innerHTML = `
        <div class="quiz-title">Pitanje ${current + 1} od ${total}</div>
        <div class="quiz-progress">${correct} taƒçnih</div>
      `;
      modalBody.appendChild(headerDiv);
      
      const questionDiv = document.createElement('div');
      questionDiv.className = 'quiz-question';
      questionDiv.innerHTML = `<strong>${q.eng}</strong>`;
      modalBody.appendChild(questionDiv);
      
      const optionsDiv = document.createElement('div');
      optionsDiv.className = 'quiz-options';
      
      answers.forEach(ans => {
        const btn = document.createElement('button');
        btn.textContent = ans;
        btn.className = 'quiz-option';
        btn.onclick = () => {
          if (ans === q.sr) {
            correct++;
            btn.classList.add('correct');
          } else {
            btn.classList.add('incorrect');
          }
          
          // Disable all buttons and add disabled class
          document.querySelectorAll('.quiz-option').forEach(option => {
            option.classList.add('disabled');
            option.style.pointerEvents = 'none';
          });
          
          // Update progress in header
          const progressDiv = modalBody.querySelector('.quiz-progress');
          if (progressDiv) {
            progressDiv.textContent = `${correct} taƒçnih`;
          }
          
          setTimeout(() => {
            current++;
            showAdvancedQuestion();
          }, 1500);
        };
        optionsDiv.appendChild(btn);
      });
      
      modalBody.appendChild(optionsDiv);
    }

    showAdvancedQuestion();
  }

  // Initialize with beginner level
  document.addEventListener('DOMContentLoaded', function() {
    // Set beginner as active by default
    document.querySelector('.level-btn').classList.add('active');
    loadLessons('beginner');
    
    // Update level completion indicators
    setTimeout(() => {
      updateLevelCompletionIndicators();
    }, 1000); // Wait for lessons to load
  });

  // Update notification functions
  function showUpdateNotification() {
    const notification = document.getElementById('updateNotification');
    notification.style.display = 'block';
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
      hideUpdateNotification();
    }, 10000);
  }

  function hideUpdateNotification() {
    const notification = document.getElementById('updateNotification');
    notification.style.display = 'none';
  }

  function updateApp() {
    // Show loading state
    const updateBtn = document.querySelector('.update-btn');
    const originalText = updateBtn.textContent;
    updateBtn.textContent = 'A≈æuriranje...';
    updateBtn.disabled = true;
    
    // Reload the app to get the new version
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  }

  function checkForUpdates() {
    // Check if service worker is available
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.ready.then(registration => {
        // Check for updates immediately when app loads
        registration.update().then(() => {
          console.log('Service Worker update check completed');
        });
        
        // Listen for service worker updates
        registration.addEventListener('updatefound', () => {
          console.log('New service worker version found');
          
          // Wait for the new service worker to install
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New version is ready, show notification
              showUpdateNotification();
            }
          });
        });
      });
    }
    
    // Also check for content updates by comparing file timestamps
    checkContentUpdates();
  }

  function checkContentUpdates() {
    // Add a timestamp to force cache refresh
    const timestamp = Date.now();
    
    // Check if lessons files have been updated
    fetch(`./lessons.json?v=${timestamp}`)
      .then(response => response.json())
      .then(data => {
        // Compare with cached version
        const cachedVersion = localStorage.getItem('lessons_version');
        const currentVersion = JSON.stringify(data).length; // Simple hash
        
        if (cachedVersion && cachedVersion !== currentVersion.toString()) {
          console.log('Content update detected');
          showUpdateNotification();
        }
        
        localStorage.setItem('lessons_version', currentVersion.toString());
      })
      .catch(error => {
        console.log('Error checking for content updates:', error);
      });
  }

  // Modal functions
  function showResetModal() {
    document.getElementById('resetModal').style.display = 'block';
    
    // Close modal when clicking outside
    document.getElementById('resetModal').onclick = (e) => {
      if (e.target.id === 'resetModal') {
        closeResetModal();
      }
    };
  }

  function closeResetModal() {
    document.getElementById('resetModal').style.display = 'none';
  }

  function showSuccessModal(message) {
    document.getElementById('successMessage').textContent = message;
    document.getElementById('successModal').style.display = 'block';
    
    // Close modal when clicking outside
    document.getElementById('successModal').onclick = (e) => {
      if (e.target.id === 'successModal') {
        closeSuccessModal();
      }
    };
  }

  function closeSuccessModal() {
    document.getElementById('successModal').style.display = 'none';
  }

  function confirmReset() {
    // Clear all progress and stats
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && (key.startsWith('lesson_') || key.startsWith('quiz_') || key.startsWith('level_') || key.startsWith('lessons_version'))) {
        keysToRemove.push(key);
      }
    }
    
    keysToRemove.forEach(key => localStorage.removeItem(key));
    
    closeResetModal();
    showSuccessModal('Sav napredak je uspe≈°no obrisan. Aplikacija ƒáe se osve≈æiti.');
    
    // Reload the app
    setTimeout(() => {
      window.location.reload();
    }, 2000);
  }

  // Zagrijavanje SpeechSynthesis engine-a za br≈æi prvi govor
  window.addEventListener('load', function() {
    if ('speechSynthesis' in window) {
      // Pozovi getVoices da browser uƒçita glasove
      window.speechSynthesis.getVoices();
      // Dummy neƒçujni govor
      const utter = new SpeechSynthesisUtterance('');
      utter.volume = 0;
      window.speechSynthesis.speak(utter);
    }
  });
  </script>
</body>
</html>